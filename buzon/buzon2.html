<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Crear Consulta Usuarios - ECICEP</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; max-width: 640px; margin: auto; background: #f7f7f7; padding: 20px; text-align: center; }
  img.logo { max-width: 160px; margin-bottom: 15px; }
  h2 { color: #0056b3; margin-bottom: 20px; }
  label { font-weight: bold; display: block; margin-top: 10px; text-align: left; font-size: 16px; }
  input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; font-size: 16px; border-radius: 6px; border: 1px solid #ddd; background: #fff; }
  select, select option { font-size: 18px; }
  button { background: #28a745; color: white; padding: 12px; border: none; cursor: pointer; margin-top: 16px; width: 100%; font-size: 16px; border-radius: 6px; }
  button:hover { background: #218838; }
  .hidden { display:none!important; visibility:hidden; }
  .alerta { background:#ffecec; border:1px solid #f5a9a9; color:#a94442; padding:10px; margin-top:10px; border-radius:6px; text-align:left; }
  .ok { background:#eaffea; border:1px solid #a1e3a1; color:#2e7d32; }
  .ayuda { font-size: 12px; color:#666; text-align:left; margin-top:4px; }
</style>
</head>
<body>

<img src="logo.png" alt="Logo ECICEP" class="logo" />
<h2>Crear Consulta Usuarios ECICEP Cesfam Los Álamos</h2>

<div id="msg" class="alerta hidden"></div>

<!-- Enviará a tu backend PHP -->
<form id="formECICEP" action="/buzon/submit.php" method="POST" novalidate>
  <!-- honeypot anti-spam (el backend lo ignorará si no lo usa) -->
  <div class="hidden" aria-hidden="true">
    <label>Dejar en blanco</label>
    <input type="text" name="_honey" tabindex="-1" autocomplete="off" />
  </div>

  <label for="run">RUN Usuario</label>
  <!-- name=usuario_run (lo espera submit.php) -->
  <input type="text" name="usuario_run" id="run" placeholder="Ej: 12.345.678-5" maxlength="12" required autocomplete="off" autocapitalize="characters" />
  <div class="ayuda">Escribe el RUN; se normaliza y valida el dígito verificador.</div>

  <label for="nombre_usuario">Nombre Usuario ECICEP</label>
  <!-- name=usuario_nombre -->
  <input type="text" name="usuario_nombre" id="nombre_usuario" required />

  <label for="sector">Sector</label>
  <!-- Enviamos el NOMBRE del sector; el backend lo mapea a id (sector_nombre) -->
  <select name="sector_nombre" id="sector" required>
    <option value="">Seleccione...</option>
    <option>Tres Pinos</option>
    <option>Antihuala</option>
    <option>Verde</option>
    <option>Amarillo</option>
    <option>Rojo</option>
    <option>Ranquilco</option>
    <option>Pangue</option>
  </select>

  <label for="consulta">Consulta</label>
  <!-- name=consulta_texto -->
  <textarea name="consulta_texto" id="consulta" rows="4" required></textarea>

  <label for="quien">Nombre de quien realiza la consulta</label>
  <!-- name=quien_pregunta -->
  <input type="text" name="quien_pregunta" id="quien" required />

  <!-- Parentesco: select + "Otro" -->
  <label for="parentesco">Parentesco o relación con el usuario</label>
  <!-- name=parentesco -->
  <select name="parentesco" id="parentesco" required>
    <option value="">Seleccione...</option>
    <option value="Madre">Madre</option>
    <option value="Padre">Padre</option>
    <option value="Hija/o">Hija/o</option>
    <option value="Cuidador">Cuidador</option>
    <option value="Otro">Otro</option>
  </select>

  <div id="parentesco_otro_div" class="hidden">
    <label for="parentesco_otro">Especifique:</label>
    <!-- name=parentesco_otro -->
    <input type="text" name="parentesco_otro" id="parentesco_otro" />
  </div>

  <label for="fono">Teléfono</label>
  <!-- name=contacto_celular -->
  <input type="tel" name="contacto_celular" id="fono" placeholder="+56 9 12345678" required />

  <label for="mail">Correo electrónico</label>
  <!-- Email es opcional en la BD: no ponemos required -->
  <!-- name=contacto_email -->
  <input type="email" name="contacto_email" id="mail" placeholder="nombre@correo.cl" />

  <button type="submit" id="btnEnviar">Enviar Consulta</button>
</form>

<script>
  // ========= (0) URL de API en producción =========
  const API_BASE = "https://api.ecicep.org";

  // ========= (1) Máscara RUN =========
  const runInput = document.getElementById('run');
  runInput.addEventListener('input', function(e) {
    let v = e.target.value.replace(/[^0-9kK]/g, '').toUpperCase();
    if (v.length > 1) {
      const cuerpo = v.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      const dv = v.slice(-1);
      e.target.value = cuerpo + '-' + dv;
    } else {
      e.target.value = v;
    }
  });

  // ========= (2) Normalizar para API (12345678-9) =========
  function normalizarRun(s) {
    s = (s || "").toUpperCase().replace(/[^0-9K]/g, '');
    if (s.length < 2) return s;
    return s.slice(0, -1) + '-' + s.slice(-1);
  }

  // ========= (3) Validador DV =========
  function dvValido(runNorm) {
    const m = /^(\d{7,8})-([\dK])$/.exec(runNorm);
    if (!m) return false;
    const cuerpo = m[1], dv = m[2];
    const factores = [2,3,4,5,6,7];
    let s = 0;
    for (let i = 0; i < cuerpo.length; i++) {
      s += parseInt(cuerpo[cuerpo.length - 1 - i], 10) * factores[i % factores.length];
    }
    const resto = 11 - (s % 11);
    const dvCalc = (resto === 11) ? '0' : (resto === 10) ? 'K' : String(resto);
    return dv === dvCalc;
  }

  // ========= (3.5) Mostrar/ocultar "Otro" en Parentesco =========
  const parentescoSelect = document.getElementById('parentesco');
  const parentescoOtroDiv = document.getElementById('parentesco_otro_div');
  const parentescoOtroInput = document.getElementById('parentesco_otro');

  parentescoSelect.addEventListener('change', () => {
    if (parentescoSelect.value === 'Otro') {
      parentescoOtroDiv.classList.remove('hidden');
      parentescoOtroInput.required = true;
    } else {
      parentescoOtroDiv.classList.add('hidden');
      parentescoOtroInput.required = false;
      parentescoOtroInput.value = '';
    }
  });

  // ========= (4) Interceptar envío =========
  const form = document.getElementById('formECICEP');
  const msg = document.getElementById('msg');
  const btn = document.getElementById('btnEnviar');
  const nombreInput = document.getElementById('nombre_usuario');

  function setMsg(texto, ok=false) {
    msg.textContent = texto;
    msg.classList.remove('hidden', 'ok');
    if (ok) msg.classList.add('ok');
  }
  function clearMsg() {
    msg.classList.add('hidden');
    msg.classList.remove('ok');
    msg.textContent = '';
  }

  form.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    clearMsg();
    btn.disabled = true;
    const oldText = btn.textContent;
    btn.textContent = "Verificando…";

    const runCanonico = normalizarRun(runInput.value);
    if (!dvValido(runCanonico)) {
      setMsg("RUN inválido (revise el dígito verificador).");
      btn.disabled = false; btn.textContent = oldText;
      return;
    }

    try {
      const url = `${API_BASE}/api/verificar_run?run=${encodeURIComponent(runCanonico)}`;
      const res = await fetch(url, { method: 'GET', mode: 'cors', cache: 'no-store' });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();

      if (!data.ok) {
        setMsg("Error al verificar RUN. Intente nuevamente.");
        btn.disabled = false; btn.textContent = oldText;
        return;
      }
      if (!data.existe) {
        setMsg("Usuario no ingresado en Estrategia ECICEP.");
        btn.disabled = false; btn.textContent = oldText;
        return;
      }

      if (data.nombre && !nombreInput.value) nombreInput.value = data.nombre;

      btn.textContent = "Enviando…";
      form.submit(); // ahora va a /buzon/submit.php
    } catch (err) {
      setMsg("No se pudo contactar al verificador. Revise conexión.");
      console.error("Fetch error:", err);
      btn.disabled = false; btn.textContent = oldText;
    }
  });
</script>

</body>
</html>
